<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Frostmaiden Day Generator</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #1e3c72;
      color: #e0f7fa;
      text-align: center;
      padding: 2em;
      overflow: hidden;
      position: relative;
    }

    #snow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
    }

    .snowflake {
      position: absolute;
      top: -10px;
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      opacity: 0.8;
      animation: fall linear infinite;
    }

    @keyframes fall {
      to {
        transform: translateY(100vh);
      }
    }

    button {
      font-size: 1rem;
      padding: 0.8em 1.5em;
      border: none;
      background-color: #00bcd4;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      margin: 0.5em;
    }

    pre {
      text-align: left;
      margin-top: 2em;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 1em;
      border-radius: 1em;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="snow"></div>
  <h1>🧊 Frostmaiden Day Generator</h1>
  <button onclick="generateDay()">Generate Day</button>
  <pre id="output"></pre>

  <script>
    let snowInterval = null;

    function roll(sides, times = 1) {
      let results = [];
      for (let i = 0; i < times; i++) {
        results.push(Math.floor(Math.random() * sides) + 1);
      }
      return times === 1 ? results[0] : results;
    }

    function resolveTime(period) {
      const timeMap = {
        morning: ["6am", "7am", "8am", "9am", "10am", "11am"],
        afternoon: ["12pm", "1pm", "2pm", "3pm", "4pm", "5pm"],
        evening: ["6pm", "7pm", "8pm", "9pm", "10pm", "11pm"],
        night: ["12am", "1am", "2am", "3am", "4am", "5am"]
      };
      return timeMap[period][roll(6) - 1];
    }

    function createSnowflake() {
      const snowflake = document.createElement("div");
      snowflake.classList.add("snowflake");
      snowflake.style.left = `${Math.random() * 100}vw`;
      snowflake.style.animationDuration = `${5 + Math.random() * 5}s`;
      snowflake.style.opacity = Math.random();
      snowflake.style.fontSize = `${Math.random() * 10 + 10}px`;
      document.getElementById("snow").appendChild(snowflake);
      setTimeout(() => snowflake.remove(), 10000);
    }

    function startSnow() {
      stopSnow();
      snowInterval = setInterval(createSnowflake, 200);
    }

    function stopSnow() {
      clearInterval(snowInterval);
      document.getElementById("snow").innerHTML = "";
    }

    function getEncounter(blizzard) {
      const rollResult = (() => {
        while (true) {
          let r = roll(20);
          if (r === 1 && !blizzard) continue;
          if (r === 20 && blizzard) continue;
          return r;
        }
      })();

      const table = {
        1: "Yeti",
        2: "Goliath werebear",
        3: "Crag cats",
        4: "Coldlight walker",
        5: "Ice troll",
        6: "Frost druid and friends",
        7: "Chardalyn berserkers",
        8: "Frost giant riding a mammoth",
        9: "Battlehammer dwarves",
        10: "Arveiaturace (ancient white dragon)",
        11: "Snowy owlbear",
        12: "Gnolls",
        13: "Orcs of the Many-Arrows tribe",
        14: "Goliath party",
        15: "Chwinga",
        16: "Awakened beast",
        17: "Icewind kobolds",
        18: "Humans",
        19: "Herd of beasts",
        20: "Perytons"
      };

      return table[rollResult];
    }

    function generateDay() {
      stopSnow();
      const encounterRoll = roll(20);
      const weatherRoll = roll(20) + 1;
      const blizzard = weatherRoll > encounterRoll;
      const timeBlocks = ["morning", "afternoon", "evening", "night"];
      let blizzardTime = null;
      let blizzardDuration = null;
      let encounterTimes = [];

      const d8 = roll(8);
      let output = `🎲 Encounter d20: ${encounterRoll}\n🌡️ Weather d20+1: ${weatherRoll}\n`;
      output += `\n⚔️ Encounter Roll (d8): ${d8}\n`;

      function recordEncounter(time, label, desc) {
        encounterTimes.push(time);
        output += `• ${time} (${label}) — ${desc}\n`;
      }

      if (d8 >= 1 && d8 <= 4) {
        const label = timeBlocks[d8 - 1];
        const time = resolveTime(label);
        recordEncounter(time, label, getEncounter(blizzard));
      } else if (d8 <= 6) {
        const labels = [timeBlocks[roll(4) - 1], timeBlocks[roll(4) - 1]];
        const times = [resolveTime(labels[0]), resolveTime(labels[1])];
        while (labels[0] === labels[1] && times[0] === times[1]) times[1] = resolveTime(labels[1]);
        recordEncounter(times[0], labels[0], getEncounter(blizzard));
        recordEncounter(times[1], labels[1], getEncounter(blizzard));
      } else {
        output += `• No encounters today.\n`;
      }

      if (blizzard) {
        let chosenTime = null;

        if (encounterTimes.length > 0) {
          const chosenIndex = encounterTimes.length === 1 ? 0 : roll(2) - 1;
          chosenTime = encounterTimes[chosenIndex];
          const hour = parseInt(chosenTime);
          const startHour = Math.max(0, hour - roll(3));
          const duration = Math.max(2, roll(4) + roll(4));
          const hour12 = startHour % 12 || 12;
          const ampm = startHour < 12 ? "am" : "pm";
          blizzardTime = `${hour12}${ampm}`;
          blizzardDuration = duration;
        } else {
          const block = timeBlocks[roll(4) - 1];
          blizzardTime = `${resolveTime(block)} (${block})`;
          blizzardDuration = roll(4) + roll(4);
        }

        output = `🌪️ Blizzard: YES\n🕒 Start Time: ${blizzardTime}\n⏳ Duration: ${blizzardDuration} hours\n\n` + output;
        startSnow();
      } else {
        output = `🌪️ Blizzard: NO\n\n` + output;
      }

      document.getElementById("output").innerText = output;
    }
  </script>
</body>
</html>
